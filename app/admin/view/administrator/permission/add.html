{extend name="basic/page_layout" /}

{block name="body"}
<body>

<div class="popup-contain">
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <label for="" class="layui-form-label">父级</label>
            <div class="layui-input-block">
                <select name="pid" lay-verify="requried">
                    <option value="0">顶级</option>
                    {foreach $permissions as $k1=>$p1}
                    <option value="{$p1.id}">{$p1.title}</option>
                    {if isset($p1['children']) && !empty($p1['children']) }
                    {foreach $p1['children'] as $k2=>$p2}
                    <option value="{$p2.id}" >&nbsp;&nbsp;&nbsp;┗━━{$p2.title}</option>
                    {/foreach}
                    {/if}
                    {/foreach}
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="" class="layui-form-label">权限名称</label>
            <div class="layui-input-block">
                <input type="text" maxlength="16" name="title"  lay-verify="required" placeholder="请输入权限名称" class="layui-input" >
            </div>
        </div>
        <div class="layui-form-item">
            <label for="" class="layui-form-label">地址</label>
            <div class="layui-input-block">
                <input type="text" name="href" placeholder="请输入地址" class="layui-input" >
            </div>
        </div>
        <div class="layui-form-item">
            <label for="" class="layui-form-label">图标</label>
            <div class="layui-input-block">
                <div class="layui-input-inline" style="width: unset">
                    <input type="text" id="iconPicker2" name="icon" value="layui-icon-face-smile" lay-filter="iconPicker2" class="hide">
                </div>
                <div class="layui-input-inline" style="width: unset">
                    <span class="layui-btn" id="clear">清空</span>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限类型：</label>
            <div class="layui-input-block">
                <input type="radio" name="type" value="0" title="目录" checked>
                <input type="radio" name="type" value="1" title="菜单">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="" class="layui-form-label">排序</label>
            <div class="layui-input-block">
                <input type="number" step="1" min="0" name="sort" value="10" lay-verify="required" placeholder="排序权重" class="layui-input" >
            </div>
        </div>
        <div class="bottom">
            <div class="button-container">
                <button type="submit" class="layui-btn layui-btn-primary " lay-submit="" lay-filter="save">
                    <i class="layui-icon layui-icon-ok"></i>
                    提交
                </button>
                <button type="reset" class="layui-btn  ">
                    <i class="layui-icon layui-icon-refresh"></i>
                    重置
                </button>
            </div>
    </form>
</div>

<!-- 引入 layui.js 的 <script> 标签最好放置在 html 末尾 -->
<script src="/static/admin/layui/layui.js"></script>
<script src="/static/admin/config.js"></script>
<script>
    layui.use(['form','element','icon','jquery','request'],function () {
        let icon= layui.icon;
        let $ = layui.jquery;
        let form = layui.form;
        icon.render({
            elem: '#iconPicker2',
            style: 'color: #5FB878;'
            ,placeholder: ''
            ,isSplit: true
            ,page: false
            ,search: true
            ,click: function (data) {
            },
            ready: function(d) {
            }
        });

        function initNumberInput(){

            //乘法
            function mul(a, b) {
                var c = 0,
                    d = a.toString(),
                    e = b.toString();
                try {
                    c += d.split(".")[1].length;
                } catch(f) {}
                try {
                    c += e.split(".")[1].length;
                } catch(f) {}
                return Number(d.replace(".", "")) * Number(e.replace(".", "")) / Math.pow(10, c);
            }
//除法
            function div(a, b) {
                var c, d, e = 0,
                    f = 0;
                try {
                    e = a.toString().split(".")[1].length;
                } catch(g) {}
                try {
                    f = b.toString().split(".")[1].length;
                } catch(g) {}
                return c = Number(a.toString().replace(".", "")), d = Number(b.toString().replace(".", "")), mul(c / d, Math.pow(10, f - e));
            }

            function add(a, b) {
                var c, d, e;
                try {
                    c = a.toString().split(".")[1].length;
                } catch(f) {
                    c = 0;
                }
                try {
                    d = b.toString().split(".")[1].length;
                } catch(f) {
                    d = 0;
                }
                return e = Math.pow(10, Math.max(c, d)), (mul(a, e) + mul(b, e)) / e;
            }
//减法
            function sub(a, b) {
                var c, d, e;
                try {
                    c = a.toString().split(".")[1].length;
                } catch(f) {
                    c = 0;
                }
                try {
                    d = b.toString().split(".")[1].length;
                } catch(f) {
                    d = 0;
                }
                return e = Math.pow(10, Math.max(c, d)), (mul(a, e) - mul(b, e)) / e;
            }
            $("input[type=number]").each(function (el) {
                let html = '<div class="layui-inline number-input">';
                html += '<span class="layui-btn minus-btn layui-btn-primary"><i class="layui-icon layui-icon-subtraction"></i></span>'
                html += $(this).prop("outerHTML");
                html += '<span class="layui-btn plus-btn layui-btn-primary"><i class="layui-icon layui-icon-add-1"></i></span>'
                html += '</div>';
                $(this).replaceWith(html)

            });
            $('span.plus-btn').on('click',function (el) {
                let numberInput = $(this).parent().find('input');
                let step = numberInput.attr('step')
                let max = numberInput.attr('max')
                if (step === undefined){
                    step = 1;
                }
                if (max !== undefined && add(numberInput.val(),step) > max){
                    return;
                }
                numberInput.val(add(numberInput.val(),step));
            })
            $('span.minus-btn').on('click',function (el) {
                let numberInput = $(this).parent().find('input');
                let step = numberInput.attr('step')
                let min =  numberInput.attr('min')
                if (step === undefined){
                    step = 1;
                }
                if (min !== undefined && sub(numberInput.val(),step) < min){
                    return;
                }
                numberInput.val(sub(numberInput.val(),step));

            })
            // console.log(numberInputList)
            // for (let i = 0;i<numberInputList.length;i++){
            //     let html = '<div class="">';
            //     console.log($(numberInputList[i]))
            //     html += $(numberInputList).html();
            //     html += '</div>';
            //     console.log(html)
            // }

        }

        initNumberInput()



        $('#clear').click(function() {
            $('#iconPicker2').attr("value","");
            $('#iconPicker2').attr("title","");
            $('.layui-iconpicker-main').children("i").attr("class","layui-icon layui-icon-face-smile");
            $('.layui-iconpicker-main').children("span").remove();
        });

        form.on('submit(save)', function(data){
            if(data.field.icon){
                data.field.icon = "layui-icon" + data.field.icon;
            }
            $.ajax({
                data:JSON.stringify(data.field),
                dataType:'json',
                contentType:'application/json',
                type:'post',
                success:function(res){
                    //判断有没有权限
                    if(res && res.code==999){
                        layer.msg(res.msg, {
                            icon: 5,
                            time: 2000,
                        })
                        return false;
                    }else if(res.code==200){
                        layer.msg(res.msg,{icon:1,time:1000},function(){
                            parent.layer.close(parent.layer.getFrameIndex(window.name));//关闭当前页
                            top.location.reload();
                        });
                    }else{
                        layer.msg(res.msg,{icon:2,time:1000});
                    }
                }
            })
            return false;
        });
    });


</script>
</body>

{/block}